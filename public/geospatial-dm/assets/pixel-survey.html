<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Pixel Map</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">

<script src="https://d3js.org/d3.v7.min.js"></script>
<script src="https://d3js.org/d3-scale-chromatic.v3.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/topojson-client@3"></script>
<script src="../../revisitUtilities/revisit-communicate.js"></script>

<style>
  :root { color-scheme: light; }
  * { box-sizing: border-box; }
  body {
    margin: 0 auto;
    width: 650px;
    height: 700px;
    font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    background: #fff;
  }

.wrap {
    display: flex;
    gap: 10px;
    align-items: flex-start;
    justify-content: center;
    max-width: 760px;
    height: 400px;
  }

  svg {
    width: 100%;
    height: auto;
    display: block;
    background: #fff;
    font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
  }

  #chart { max-width: 400px; }
  #legend { max-width: 140px; }

  .response-container {
    max-width: 600px;
    margin: 30px auto;
    padding: 0 12px;
  }

  .response-label {
    display: block;
    font-size: 16px;
    font-weight: 500;
    margin-bottom: 8px;
    color: #111;
  }

  .response-textarea {
    width: 100%;
    min-height: 120px;
    padding: 12px;
    font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    font-size: 14px;
    border: 2px solid #d1d5db;
    border-radius: 8px;
    resize: vertical;
    transition: border-color 0.2s;
  }

  .response-textarea:focus {
    outline: none;
    border-color: #2563eb;
  }

  .response-textarea::placeholder {
    color: #9ca3af;
  }

</style>
</head>
<body>

<div class="wrap">
  <!-- Map SVG -->
  <svg id="chart" viewBox="0 0 400 400" aria-label="Pixel map of selected state"></svg>

  <!--- Legend SVG (separate) -->
  <svg id="legend" viewBox="0 0 140 400" aria-label="Legend"></svg>
</div>

<div class="response-container">
  <label for="response-text" class="response-label">
You have seen many example maps like the one above. How did you use the map to recommend counties that should receive financial assistance? Please describe your thought process in as much detail as possible.</label>
  <textarea
    id="response-text"
    class="response-textarea"
    placeholder="Type your response here..."
    aria-label="Open response text box"></textarea>
</div>

<script>

const svgMap    = d3.select("#chart");
const svgLegend = d3.select("#legend");

const width = 400, height = 400;  
const PIXEL = 3;
const MOE_Z = 1.645;
const VALUE_MIN = 0, VALUE_MAX = 50;
const MAX_SELECTIONS = 3;
const REQUIRED_SELECTIONS = 3;

//const longpal = ["#800026","#BD0026","#E31A1C","#FC4E2A","#FD8D3C","#FEB24C","#FED976","#FFE7A8","#FFF2CC","#FFF9E6"].reverse();
//const color = d3.scaleLinear()
  //.domain(d3.range(VALUE_MIN, VALUE_MAX + 1, (VALUE_MAX - VALUE_MIN) / (longpal.length - 1)))
  //.range(longpal)
  //.clamp(true);

const color = d3.scaleSequential(d3.interpolateYlOrRd)
    .domain([VALUE_MIN, VALUE_MAX])
    .clamp(true);


function mulberry32(a){ return function(){ let t=a+=0x6D2B79F5; t=Math.imul(t^t>>>15,t|1); t^=t+Math.imul(t^t>>>7,t|61); return ((t^t>>>14)>>>0)/4294967296; } }
function randnFactory(rng){ let spare=null; return ()=>{ if(spare!==null){const v=spare; spare=null; return v;}
  let u=0,v=0,s=0; do{u=rng()*2-1; v=rng()*2-1; s=u*u+v*v;}while(s===0||s>=1);
  const m=Math.sqrt(-2*Math.log(s)/s); spare=v*m; return u*m; }; }
function sampleValue(pov, moe, randn){
  const sd = (moe ?? 0)/MOE_Z;
  const x = pov + (sd>0 ? randn()*sd : 0);
  return Math.max(VALUE_MIN, Math.min(VALUE_MAX, x));
}


const norm = s => (s||"").normalize("NFD").replace(/\p{Diacritic}/gu,"").toLowerCase().trim();
const stripTypeSuffix = (s) =>
  s.replace(/\b(county|parish|borough|census area|municipio|municipality)\b/gi, "")
   .replace(/\s+/g, " ")
   .trim();

const defsMap   = svgMap.append("defs");
const gPixels   = svgMap.append("g").attr("class","pixels");
const gState    = svgMap.append("g").attr("class","state");
const gCounties = svgMap.append("g").attr("class","counties");

let projection;
let path;

function renderState(stateFips, csvFile) {
  
  Promise.all([
    d3.json("https://cdn.jsdelivr.net/npm/us-atlas@3/counties-10m.json"),
    d3.csv(csvFile, d3.autoType)
  ])
  .then((results) => {
    const usTopo = results[0];
    const csv = results[1];
    
    gPixels.selectAll("*").remove();
    gState.selectAll("*").remove();
    gCounties.selectAll("*").remove();
    //gLabels.selectAll("*").remove();
    defsMap.selectAll("*").remove();

    const allCounties = topojson.feature(usTopo, usTopo.objects.counties).features;
    const stateCounties = allCounties.filter(f => String(f.id).startsWith(stateFips));
    const stateMesh = topojson.mesh(usTopo, usTopo.objects.counties,
                        (a,b)=> String(a.id).startsWith(stateFips) && String(b.id).startsWith(stateFips) && a!==b);
    
    const stateFeature  = topojson.feature(usTopo, usTopo.objects.states).features.find(f => String(f.id) === stateFips);

    const nameToFipsMap = new Map();
    
    for (const f of stateCounties) {
      const id  = String(f.id);
      const raw = f.properties?.name ?? "";
      const base = norm(stripTypeSuffix(raw));
      nameToFipsMap.set(base, id);
      
      if (/\bsaint\b/i.test(raw)) {
        nameToFipsMap.set(norm(stripTypeSuffix(raw.replace(/\bsaint\b/gi, "st"))), id);
        nameToFipsMap.set(norm(stripTypeSuffix(raw.replace(/\bsaint\b/gi, "st."))), id);
      }
      if (/\bst[.]?\b/iu.test(raw)) {
        nameToFipsMap.set(norm(stripTypeSuffix(raw.replace(/\bst[.]?\b/giu, "saint"))), id);
      }
    }

    const byFips = new Map();
    for (const r of csv) {
      const rawName = String(r.county ?? r.NAME ?? "");
      const key = norm(stripTypeSuffix(rawName));
      const fips = nameToFipsMap.get(key);
      if (fips) {
        byFips.set(fips, { pov:+r.pov, moe:+r.moe, name: rawName });
      } else {
        console.warn(`No FIPS match for county name: "${rawName}" in state FIPS ${stateFips}`);
      }
    }

let projection = d3.geoEquirectangular();
let path = d3.geoPath(projection);
projection.fitSize([width, height], {type:"FeatureCollection", features: stateCounties});

    
    defsMap.append("clipPath").attr("id","stateClip")
      .append("path").attr("d", path(stateFeature));

    // State outline
    gState.append("path")
      .attr("d", path(stateFeature))
      .attr("fill","none")
      .attr("stroke","#595959")
      .attr("stroke-width",1)
      .attr("vector-effect","non-scaling-stroke");

    // County borders
    gCounties.append("path")
      .attr("d", path(stateMesh))
      .attr("fill","none")
      .attr("stroke","#595959")
      .attr("stroke-width",1)
      .attr("vector-effect","non-scaling-stroke");

    // Labels 
    /*gLabels.selectAll("text")
      .data(stateCounties)
      .join("text")
        .attr("class","label")
        .attr("transform", d => `translate(${path.centroid(d)})`)
        .text(d => byFips.get(String(d.id))?.name ?? String(d.id)); */

    // Pixel field
    const rng = mulberry32(42);
    const randn = randnFactory(rng);
    const pixels = [];

    for (let y = PIXEL/2; y < height; y += PIXEL) {
      for (let x = PIXEL/2; x < width; x += PIXEL) {
        const lonlat = projection.invert([x,y]);
        if (!lonlat) continue;

        let rec = null;
        for (const f of stateCounties) {
          if (d3.geoContains(f, lonlat)) { rec = byFips.get(String(f.id)); break; }
        }
        if (!rec) continue;

        const v = sampleValue(rec.pov, rec.moe, randn);
        pixels.push({x, y, v});
      }
    }

    gPixels.attr("clip-path","url(#stateClip)")
      .selectAll("rect")
      .data(pixels)
      .join("rect")
        .attr("x", d => d.x - PIXEL/2)
        .attr("y", d => d.y - PIXEL/2)
        .attr("width", PIXEL)
        .attr("height", PIXEL)
        .attr("fill", d => color(d.v));

    gCounties.selectAll(".county")
      .data(stateCounties)
      .join("path")
        .attr("class", "county")
        .attr("d", path)
        .attr("fill", "transparent")
        .attr("stroke", "none");

    svgLegend.selectAll("*").remove(); // clear previous legend
    const defsL = svgLegend.append("defs");

    const LEGEND_LEFT  = 40;  
    const LEGEND_TOP   = 40;  
    const LEGEND_LONG  = 320; 
    const LEGEND_THICK = 15;  
    const lg = svgLegend.append("g")
      .attr("class", "legend-right")
      .attr("transform", `translate(${LEGEND_LEFT}, ${LEGEND_TOP})`)
      .style("pointer-events", "none");

    const grad = defsL.append("linearGradient")
      .attr("id", "legendGrad")
      .attr("x1", "0%").attr("x2", "0%")
      .attr("y1", "100%").attr("y2", "0%");
    for (let i = 0; i <= 100; i++) {
      const t = i / 100;
      grad.append("stop")
        .attr("offset", `${i}%`)
        .attr("stop-color", color(VALUE_MIN + t * (VALUE_MAX - VALUE_MIN)));
    }

    lg.append("rect")
      .attr("width",  LEGEND_THICK)
      .attr("height", LEGEND_LONG)
      .attr("fill", "url(#legendGrad)")
      .attr("rx", 3);

    const legendScale = d3.scaleLinear()
      .domain([VALUE_MAX, VALUE_MIN])
      .range([0, LEGEND_LONG]);

    lg.append("g")
      .attr("transform", `translate(${LEGEND_THICK}, 0)`)
      .call(d3.axisRight(legendScale).ticks(5));

    lg.append("text")
      .attr("x", 0)
      .attr("y", -12)
      .attr("font-weight", 500)
      .text("Poverty");
  })
  .catch(err => {
    console.error('Error loading data:', err);
    console.error('Error stack:', err.stack);
    console.error('State FIPS:', stateFips, 'CSV file:', csvFile);
    alert("Data load failed: " + err.message + ". Check console for details.");
  });
}

const stateFips = '04';  
const csvFile = 'Data/AZData4.csv'; 
renderState(stateFips, csvFile);

const responseTextarea = document.getElementById('response-text');

responseTextarea.addEventListener('input', () => {
  const responseText = responseTextarea.value;
  Revisit.postAnswers({ openResponse: responseText });
});
</script>
</body>
</html>
