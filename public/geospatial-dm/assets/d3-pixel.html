<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Pixel Map</title>
<!-- Get prettier-->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">

<script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
<script src="https://cdn.jsdelivr.net/npm/topojson-client@3"></script>
<script src="../../revisitUtilities/revisit-communicate.js"></script>

<style>
  :root { color-scheme: light; }
  * { box-sizing: border-box; }
  body {
    margin: 0;
    font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    background: #fff;
  }

 
  .viz-wrap {
    display: flex;
    gap: 16px;
    align-items: flex-start;
    justify-content: center;
    max-width: 760px; 
    margin: 0 auto;
    padding: 0 12px;
  }

  svg {
    width: 100%;
    height: auto;
    display: block;
    background: #fff;
    font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
  }

  #chart { max-width: 400px; }
  #legend { max-width: 140px; }

  .label {
    font-size: 10px;
    fill: #111;
    text-anchor: middle;
    paint-order: stroke;
    stroke: #fff;
    stroke-width: 3px;
    font-weight: 500;
    letter-spacing: 0.01em;
  }

  #county-message-box {
    font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
  }


  @media (max-width: 400px) {
    .viz-wrap { flex-direction: column; align-items: center; max-width: 400px; }
    #legend { max-width: 400px; }
  }
</style>
</head>
<body>

<div class="viz-wrap">
  <!-- Map SVG -->
  <svg id="chart" viewBox="0 0 400 400" aria-label="Pixel map of selected state"></svg>

  <!--- Legend SVG (separate) -->
  <svg id="legend" viewBox="0 0 140 400" aria-label="Legend"></svg>
</div>

<div id="county-message-box"
     style="display:none; margin:0; padding:18px 22px; border:2px solid #0077cc; border-radius:14px;
            background:linear-gradient(135deg,rgba(247,251,255,0.85) 80%,rgba(227,242,253,0.85) 100%);
            max-width:320px; font-size:16px; box-shadow:0 4px 18px rgba(0,0,0,0.18); z-index:1000;
            position:absolute; transition:box-shadow 0.2s,transform 0.2s; opacity:0.92;"></div>

<script>

const svgMap    = d3.select("#chart");
const svgLegend = d3.select("#legend");

const width = 400, height = 400;  
const PIXEL = 3;
const MOE_Z = 1.645;
const VALUE_MIN = 0, VALUE_MAX = 50;

const longpal = ["#800026","#BD0026","#E31A1C","#FC4E2A","#FD8D3C","#FEB24C","#FED976","#FFE7A8","#FFF2CC","#FFF9E6"].reverse();
const color = d3.scaleLinear()
  .domain(d3.range(VALUE_MIN, VALUE_MAX + 1, (VALUE_MAX - VALUE_MIN) / (longpal.length - 1)))
  .range(longpal)
  .clamp(true);


function mulberry32(a){ return function(){ let t=a+=0x6D2B79F5; t=Math.imul(t^t>>>15,t|1); t^=t+Math.imul(t^t>>>7,t|61); return ((t^t>>>14)>>>0)/4294967296; } }
function randnFactory(rng){ let spare=null; return ()=>{ if(spare!==null){const v=spare; spare=null; return v;}
  let u=0,v=0,s=0; do{u=rng()*2-1; v=rng()*2-1; s=u*u+v*v;}while(s===0||s>=1);
  const m=Math.sqrt(-2*Math.log(s)/s); spare=v*m; return u*m; }; }
function sampleValue(pov, moe, randn){
  const sd = (moe ?? 0)/MOE_Z;
  const x = pov + (sd>0 ? randn()*sd : 0);
  return Math.max(VALUE_MIN, Math.min(VALUE_MAX, x));
}


const norm = s => (s||"").normalize("NFD").replace(/\p{Diacritic}/gu,"").toLowerCase().trim();
const stripTypeSuffix = (s) =>
  s.replace(/\b(county|parish|borough|census area|municipio|municipality)\b/gi, "")
   .replace(/\s+/g, " ")
   .trim();

const defsMap   = svgMap.append("defs");
const gPixels   = svgMap.append("g").attr("class","pixels");
const gState    = svgMap.append("g").attr("class","state");
const gCounties = svgMap.append("g").attr("class","counties");
const gLabels   = svgMap.append("g").attr("class","labels");

const projection = d3.geoEquirectangular();
const path = d3.geoPath(projection);


function renderState(stateFips, csvFile) {
  Promise.all([
    d3.json("https://cdn.jsdelivr.net/npm/us-atlas@3/counties-10m.json"),
    d3.csv(csvFile, d3.autoType)
  ])
  .then(([usTopo, csv]) => {
    gPixels.selectAll("*").remove();
    gState.selectAll("*").remove();
    gCounties.selectAll("*").remove();
    gLabels.selectAll("*").remove();
    defsMap.selectAll("*").remove();

    const allCounties   = topojson.feature(usTopo, usTopo.objects.counties).features;
    const stateCounties = allCounties.filter(f => String(f.id).startsWith(stateFips));
    const stateFeature  = topojson.feature(usTopo, usTopo.objects.states).features.find(f => String(f.id) === stateFips);
    const stateMesh     = topojson.mesh(usTopo, usTopo.objects.counties,
                          (a,b)=> String(a.id).startsWith(stateFips) && String(b.id).startsWith(stateFips) && a!==b);

    const nameToFipsMap = new Map();
    for (const f of stateCounties) {
      const id  = String(f.id);
      const raw = f.properties?.name ?? "";
      const base = norm(stripTypeSuffix(raw));
      nameToFipsMap.set(base, id);

      if (/\bsaint\b/i.test(raw)) {
        nameToFipsMap.set(norm(stripTypeSuffix(raw.replace(/\bsaint\b/gi, "st"))), id);
        nameToFipsMap.set(norm(stripTypeSuffix(raw.replace(/\bsaint\b/gi, "st."))), id);
      }
      if (/\bst[.]?\b/iu.test(raw)) {
        nameToFipsMap.set(norm(stripTypeSuffix(raw.replace(/\bst[.]?\b/giu, "saint"))), id);
      }
    }

    const byFips = new Map();
    for (const r of csv) {
      const rawName = String(r.county ?? r.NAME ?? "");
      const key = norm(stripTypeSuffix(rawName));
      const fips = nameToFipsMap.get(key);
      if (fips) {
        byFips.set(fips, { pov:+r.pov, moe:+r.moe, name: rawName });
      } else {
        console.warn(`No FIPS match for county name: "${rawName}" in state FIPS ${stateFips}`);
      }
    }

    projection.fitSize([width, height], {type:"FeatureCollection", features: stateCounties});

    defsMap.append("clipPath").attr("id","stateClip")
      .append("path").attr("d", path(stateFeature));

    // State outline
    gState.append("path")
      .attr("d", path(stateFeature))
      .attr("fill","none")
      .attr("stroke","#333")
      .attr("stroke-width",1.2)
      .attr("vector-effect","non-scaling-stroke");

    // County borders
    gCounties.append("path")
      .attr("d", path(stateMesh))
      .attr("fill","none")
      .attr("stroke","#595959")
      .attr("stroke-width",1.2)
      .attr("vector-effect","non-scaling-stroke");

    // Labels 
    gLabels.selectAll("text")
      .data(stateCounties)
      .join("text")
        .attr("class","label")
        .attr("transform", d => `translate(${path.centroid(d)})`)
        .text(d => byFips.get(String(d.id))?.name ?? String(d.id));

    // Pixel field
    const rng = mulberry32(42);
    const randn = randnFactory(rng);
    const pixels = [];

    for (let y = PIXEL/2; y < height; y += PIXEL) {
      for (let x = PIXEL/2; x < width; x += PIXEL) {
        const lonlat = projection.invert([x,y]);
        if (!lonlat) continue;

        let rec = null;
        for (const f of stateCounties) {
          if (d3.geoContains(f, lonlat)) { rec = byFips.get(String(f.id)); break; }
        }
        if (!rec) continue;

        const v = sampleValue(rec.pov, rec.moe, randn);
        pixels.push({x, y, v});
      }
    }

    gPixels.attr("clip-path","url(#stateClip)")
      .selectAll("rect")
      .data(pixels)
      .join("rect")
        .attr("x", d => d.x - PIXEL/2)
        .attr("y", d => d.y - PIXEL/2)
        .attr("width", PIXEL)
        .attr("height", PIXEL)
        .attr("fill", d => color(d.v));

    let selectedCounties = [];
    const maxSelections = 3;

    function showCountyMessageBox({ county, alreadySelected, onYes, onNo }) {
      const box = document.getElementById("county-message-box");
      let msg = "";
      if (!alreadySelected) {
        msg = `Do you want to allocate your resources to <b>${county}</b>?`;
      } else {
        msg = `You have already selected <b>${county}</b> to allocate resources.<br>Do you want to unselect it?`;
      }
      msg += `<br><br><b>Selected counties:</b> <span style='color:#0077cc'>${selectedCounties.length ? selectedCounties.join(", ") : "None"}</span>`;
      box.innerHTML = msg + `<br><br><button id='county-yes-btn' style='background:#0077cc;color:#fff;border:none;border-radius:6px;padding:7px 18px;margin-right:10px;cursor:pointer;font-size:15px;box-shadow:0 1px 4px rgba(0,0,0,0.08);transition:background 0.2s;'>Yes</button> <button id='county-no-btn' style='background:#fff;color:#0077cc;border:1.5px solid #0077cc;border-radius:6px;padding:7px 18px;cursor:pointer;font-size:15px;box-shadow:0 1px 4px rgba(0,0,0,0.08);transition:background 0.2s;'>No</button>`;
      box.style.display = "block";

      let countyFeature = null;
      for (const f of stateCounties) {
        const name = byFips.get(String(f.id))?.name ?? String(f.id);
        if (name === county) { countyFeature = f; break; }
      }
      const svgEl = document.getElementById("chart");
      const svgRect = svgEl.getBoundingClientRect();
      box.style.position = "absolute";
      if (countyFeature) {
        const centroid = path.centroid(countyFeature);
        box.style.left = (svgRect.left + centroid[0]) + "px";
        box.style.top  = (svgRect.top  + centroid[1]) + "px";
        box.style.transform = "translate(-50%, 20px)";
      } else {
        box.style.left = (svgRect.left + 20) + "px";
        box.style.top  = (svgRect.top  + 20) + "px";
        box.style.transform = "none";
      }
      box.style.zIndex = 1000;

      document.getElementById("county-yes-btn").onclick = () => { box.style.display = "none"; onYes(); };
      document.getElementById("county-no-btn").onclick  = () => { box.style.display = "none"; onNo();  };
    }

    gCounties.selectAll(".county-interactive")
      .data(stateCounties)
      .join("path")
        .attr("class", "county-interactive")
        .attr("d", path)
        .attr("fill", "transparent")
        .attr("stroke", "none")
        .attr("data-county", d => byFips.get(String(d.id))?.name ?? String(d.id))
        .style("cursor", "pointer")
        .on("click", function(event, d) {
          const county = d3.select(this).attr("data-county");
          if (!selectedCounties.includes(county)) {
            if (selectedCounties.length >= maxSelections) return;
            showCountyMessageBox({
              county,
              alreadySelected: false,
              onYes: () => {
                selectedCounties.push(county);
                Revisit.postAnswers({ selectedCounty: selectedCounties });
                if (selectedCounties.length === maxSelections) {
                  gCounties.selectAll(".county-interactive")
                    .filter(function() {
                      return !selectedCounties.includes(d3.select(this).attr("data-county"));
                    })
                    .style("pointer-events", "none");
                }
              },
              onNo: () => {}
            });
          } else {
            showCountyMessageBox({
              county,
              alreadySelected: true,
              onYes: () => {
                selectedCounties = selectedCounties.filter(c => c !== county);
                Revisit.postAnswers({ selectedCounty: selectedCounties });
                if (selectedCounties.length < maxSelections) {
                  gCounties.selectAll(".county-interactive").style("pointer-events", "auto");
                }
              },
              onNo: () => {}
            });
          }
        });

    svgLegend.selectAll("*").remove(); // clear previous legend
    const defsL = svgLegend.append("defs");

    const LEGEND_LEFT  = 40;  
    const LEGEND_TOP   = 40;  
    const LEGEND_LONG  = 320; 
    const LEGEND_THICK = 15;  
    const lg = svgLegend.append("g")
      .attr("class", "legend-right")
      .attr("transform", `translate(${LEGEND_LEFT}, ${LEGEND_TOP})`)
      .style("pointer-events", "none");

    // Vertical gradient (top -> bottom)
    const grad = defsL.append("linearGradient")
      .attr("id", "legendGrad")
      .attr("x1", "0%").attr("x2", "0%")
      .attr("y1", "100%").attr("y2", "0%");
    for (let i = 0; i <= 100; i++) {
      const t = i / 100;
      grad.append("stop")
        .attr("offset", `${i}%`)
        .attr("stop-color", color(VALUE_MIN + t * (VALUE_MAX - VALUE_MIN)));
    }

    // Gradient bar
    lg.append("rect")
      .attr("width",  LEGEND_THICK)
      .attr("height", LEGEND_LONG)
      .attr("fill", "url(#legendGrad)")
      .attr("rx", 3);

    // Scale: top = max, bottom = min
    const legendScale = d3.scaleLinear()
      .domain([VALUE_MAX, VALUE_MIN])
      .range([0, LEGEND_LONG]);

    // Axis ticks to the right of bar
    lg.append("g")
      .attr("transform", `translate(${LEGEND_THICK}, 0)`)
      .call(d3.axisRight(legendScale).ticks(5));

    // Title
    lg.append("text")
      .attr("x", 0)
      .attr("y", -12)
      .attr("font-weight", 500)
      .text("Poverty");
  })
  .catch(err => {
    console.error(err);
    alert("Data load failed. Serve the folder with a local web server and keep the CSV next to this HTML file.");
  });
}


Revisit.onDataReceive((data) => {
  const stateFips = data['stateFips'];
  const csvFile   = data['csvFile'];
  renderState(stateFips, csvFile);
});
</script>
</body>
</html>
