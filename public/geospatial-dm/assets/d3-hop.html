<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Hypothetical Outcome Map (HOM) — D3 (No Controls)</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
<script src="https://cdn.jsdelivr.net/npm/topojson-client@3"></script>
<!-- Minimal ReVISit shim (safe if real ReVISit is present) -->
<script>
  window.Revisit = window.Revisit || {};
  if (!('postAnswers' in window.Revisit)) window.Revisit.postAnswers = (msg)=>console.log("Revisit.postAnswers:", msg);
  if (!('onDataReceive' in window.Revisit)) window.Revisit.onDataReceive = (f)=>{ window.__revisitHandler = f; };
</script>
<style>
  :root { color-scheme: light; }
  * { box-sizing: border-box; }
  body { margin:0; font-family:'Inter', system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background:#fff; }

  .wrap { max-width:600px; margin:0 auto; padding:10px 14px 28px; }
  svg { width:100%; height:auto; display:block; background:#fff; }
  #map { aspect-ratio:1/1; }

  /* county fills for HOM */
  .county { stroke:#777; stroke-width:0.8; vector-effect:non-scaling-stroke; }
  .county.on  { fill:#800000; }  /* allocate */
  .county.off { fill:#e9e9e9; }  /* not allocate */
  .county.hover { stroke:#111; stroke-width:1.5; }

  .state-outline { fill:none; stroke:#222; stroke-width:1.2; vector-effect:non-scaling-stroke; }

  /* tooltip (optional) */
  .tip { position:fixed; pointer-events:none; transform:translate(8px,8px); background:#fff;
         border:1px solid #ddd; border-radius:10px; padding:8px 10px; font-size:12px; color:#111;
         box-shadow:0 4px 16px rgba(0,0,0,0.08); display:none; }

  /* legend (non-interactive) */
  .legend { position:fixed; right:14px; bottom:14px; background:#fff; border:1px solid #e5e5e5;
            border-radius:10px; padding:8px 10px; font-size:12px; color:#222; box-shadow:0 2px 10px rgba(0,0,0,0.05); }
  .chip { width:12px; height:12px; border-radius:3px; display:inline-block; vertical-align:middle; margin-right:6px; border:1px solid #777; }
  .chip.on  { background:#800000; border-color:#800000; }
  .chip.off { background:#e9e9e9; border-color:#aaa; }
</style>
</head>
<body>
  <div class="wrap">
    <svg id="map" viewBox="0 0 400 400" aria-label="HOM county map"></svg>
  </div>
  <div class="legend"><span class="chip on"></span> Allocate &nbsp; <span class="chip off"></span> Not allocate</div>
  <div class="tip" id="tip"></div>

<script>

const CONFIG = {
  STATE_FIPS: '35',            // New Mexico
  CSV_FILE: 'NMData.csv',      // columns: county,pov,moe (same units as THRESHOLD)
  THRESHOLD: 20,               // decision threshold (e.g., percent points)
  MOE_Z: 1.645,                // sd = moe / MOE_Z (1.645 for 90% MOE)
  N_FRAMES: 50,                // HOM frames
  FPS: 8,                      // frames per second
  MAX_SELECTIONS: 3,           // max counties participant can select
  RNG_SEED: 42                 // seed basis for draws
};


const svg = d3.select('#map');
const gFill = svg.append('g');
const gBorders = svg.append('g');
const gOutline = svg.append('g');

const projection = d3.geoEquirectangular();
const path = d3.geoPath(projection);

const tip = document.getElementById('tip');

const norm = s => (s||"").normalize("NFD").replace(/\p{Diacritic}/gu,"").toLowerCase().trim();
const stripTypeSuffix = (s) => s.replace(/\b(county|parish|borough|census area|municipio|municipality)\b/gi, "").replace(/\s+/g, " ").trim();

function mulberry32(a){ return function(){ let t=a+=0x6D2B79F5; t=Math.imul(t^t>>>15,t|1); t^=t+Math.imul(t^t>>>7,t|61); return ((t^t>>>14)>>>0)/4294967296; }; }
function hashStr(str){ let h=2166136261; for(let i=0;i<str.length;i++){ h^=str.charCodeAt(i); h = Math.imul(h, 16777619); } return h>>>0; }

// Normal CDF via erf approximation
function normalCdf(x, mean=0, sd=1){ const z=(x-mean)/(sd||1); return 0.5 * (1 + erf(z/Math.SQRT2)); }
function erf(x){ const sign = Math.sign(x); const a1=0.254829592, a2=-0.284496736, a3=1.421413741, a4=-1.453152027, a5=1.061405429, p=0.3275911;
  const t = 1/(1+p*Math.abs(x)); const y = 1-((((a5*t+a4)*t+a3)*t+a2)*t+a1)*t*Math.exp(-x*x); return sign*y; }


let state = {
  stateFips: CONFIG.STATE_FIPS,
  csvFile: CONFIG.CSV_FILE,
  threshold: CONFIG.THRESHOLD,
  moeZ: CONFIG.MOE_Z,
  fps: CONFIG.FPS,
  nFrames: CONFIG.N_FRAMES,
  frame: 0,
  selected: [],
  maxSel: CONFIG.MAX_SELECTIONS,
  rngSeed: CONFIG.RNG_SEED,
  draws: [],
  countyList: [],        // topo features
  byFips: new Map()      // fips -> { name, pov, moe, xprob }
};


async function loadData(){
  const [usTopo, csv] = await Promise.all([
    d3.json('https://cdn.jsdelivr.net/npm/us-atlas@3/counties-10m.json'),
    d3.csv(state.csvFile, d3.autoType)
  ]);

  const allCounties = topojson.feature(usTopo, usTopo.objects.counties).features;
  const stateCounties = allCounties.filter(f => String(f.id).startsWith(state.stateFips));
  const stateFeature = topojson.feature(usTopo, usTopo.objects.states).features.find(f => String(f.id) === state.stateFips);
  const stateMesh = topojson.mesh(
    usTopo, usTopo.objects.counties,
    (a,b)=> String(a.id).startsWith(state.stateFips) && String(b.id).startsWith(state.stateFips) && a!==b
  );

  // name → fips dictionary with St/Saint variants
  const nameToFips = new Map();
  for(const f of stateCounties){
    const raw = f.properties?.name ?? '';
    const base = norm(stripTypeSuffix(raw));
    nameToFips.set(base, String(f.id));
    if (/\bsaint\b/i.test(raw)){
      nameToFips.set(norm(stripTypeSuffix(raw.replace(/\bsaint\b/gi,'st'))), String(f.id));
      nameToFips.set(norm(stripTypeSuffix(raw.replace(/\bsaint\b/gi,'st.'))), String(f.id));
    }
    if (/\bst[.]?\b/i.test(raw)){
      nameToFips.set(norm(stripTypeSuffix(raw.replace(/\bst[.]?\b/gi,'saint'))), String(f.id));
    }
  }

  // Join CSV → FIPS
  const byFips = new Map();
  for(const r of csv){
    const rawName = String(r.county ?? r.NAME ?? '').trim();
    const key = norm(stripTypeSuffix(rawName));
    const fips = nameToFips.get(key);
    if (!fips) { console.warn('No FIPS for', rawName); continue; }
    byFips.set(fips, { name: rawName, pov:+r.pov, moe:+r.moe });
  }

  // Projection & static layers
  projection.fitSize([400,400], {type:'FeatureCollection', features: stateCounties});

  svg.selectAll('*').interrupt();
  gFill.selectAll('*').remove();
  gBorders.selectAll('*').remove();
  gOutline.selectAll('*').remove();

  gOutline.append('path').attr('class','state-outline').attr('d', path(stateFeature));
  gBorders.append('path')
    .attr('d', path(stateMesh))
    .attr('fill','none').attr('stroke','#666').attr('stroke-width',0.8)
    .attr('vector-effect','non-scaling-stroke');

  // County paths (we only flip classes per frame)
  gFill.selectAll('path.county')
    .data(stateCounties, d=>String(d.id))
    .join('path')
      .attr('class','county off')
      .attr('d', d=>path(d))
      .attr('data-fips', d=>String(d.id))
      .on('mousemove', (event,d)=>{
        const rec = byFips.get(String(d.id));
        tip.style.display = 'block';
        tip.style.left = (event.clientX)+ 'px';
        tip.style.top  = (event.clientY)+ 'px';
        const xp = rec?.xprob != null ? rec.xprob : NaN;
        tip.innerHTML = `<b>${rec?.name ?? 'Unknown'}</b><br/>xprob = ${isFinite(xp)? xp.toFixed(3): 'NA'}`;
      })
      .on('mouseleave', ()=>{ tip.style.display='none'; })
      .on('click', (event,d)=>{
        const name = byFips.get(String(d.id))?.name ?? String(d.id);
        const idx = state.selected.indexOf(name);
        if (idx === -1){
          if (state.selected.length >= state.maxSel) return;
          state.selected.push(name);
        } else {
          state.selected.splice(idx,1);
        }
        Revisit.postAnswers({ selectedCounty: state.selected });
      })
      .on('mouseenter', function(){ d3.select(this).classed('hover', true); })
      .on('mouseout', function(){ d3.select(this).classed('hover', false); });

  state.countyList = stateCounties;
  state.byFips = byFips;

  computeXprob();
  regenerateDraws();
  renderFrame(0, true);
}

function computeXprob(){
  const t = state.threshold;
  const z = state.moeZ;
  for(const [fips, rec] of state.byFips){
    const sd = (rec.moe ?? 0) / (z || 1.645);
    rec.xprob = (!isFinite(sd) || sd <= 0)
      ? (rec.pov >= t ? 1 : 0)
      : (1 - normalCdf(t, rec.pov, sd));
  }
}

function regenerateDraws(){
  state.nFrames = CONFIG.N_FRAMES;
  state.fps = CONFIG.FPS;
  const seed = state.rngSeed = Math.abs(((+new Date()) & 0xffffffff) ^ hashStr(state.stateFips + '|' + state.csvFile + '|' + state.threshold));
  const rng0 = mulberry32(seed);
  const ids = state.countyList.map(f=>String(f.id));
  const frames = [];
  for(let k=0;k<state.nFrames;k++){
    const m = new Map();
    for(const fips of ids){
      const p = state.byFips.get(fips)?.xprob ?? 0;
      m.set(fips, rng0() < p ? 1 : 0);
    }
    frames.push(m);
  }
  state.draws = frames;
  state.frame = 0;
}

function renderFrame(k){
  state.frame = (k % state.nFrames + state.nFrames) % state.nFrames;
  const frame = state.draws[state.frame];
  gFill.selectAll('path.county')
    .classed('on', d => frame.get(String(d.id)) === 1)
    .classed('off', d => frame.get(String(d.id)) !== 1);
}

let lastTick = 0;
function loop(ts){
  const interval = 1000 / (state.fps || CONFIG.FPS);
  if (ts - lastTick >= interval){ lastTick = ts; renderFrame(state.frame+1); }
  requestAnimationFrame(loop);
}


let loopStarted = false;
function startLoopOnce(){ if (!loopStarted){ loopStarted = true; requestAnimationFrame(loop); } }


function renderState(stateFips, csvFile){
  state.stateFips = String(stateFips);
  state.csvFile = csvFile;
  state.selected = [];
  loadData().then(startLoopOnce).catch(e=>{
    console.error(e);
    alert('Data load failed. Serve with a local web server and place the CSV next to this HTML file.');
  });
}

// 1) Render right away (delete this line if you want ONLY ReVISit control)
renderState(CONFIG.STATE_FIPS, CONFIG.CSV_FILE);

// 2) If ReVISit sends data later, override (the loop keeps running)
try {
  if (typeof Revisit !== 'undefined' && typeof Revisit.onDataReceive === 'function'){
    Revisit.onDataReceive((data)=>{
      const fips = data['stateFips'];
      const csv  = data['csvFile'];
      if (!fips || !csv){
        console.warn('ReVISit data missing stateFips or csvFile');
        return;
      }
      renderState(fips, csv);
    });
  }
} catch(err){
  console.error(err);
}
</script>
</body>
</html>
