<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>NM Pixel Map â€” upright, straight grid, legend</title>
<script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
<script src="https://cdn.jsdelivr.net/npm/topojson-client@3"></script>
<script src="../../revisitUtilities/revisit-communicate.js"></script>
<style>
  body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    svg  { width: 100%; height: auto; display: block; background: #fff; margin: 0 auto; max-width: 600px; padding: 0; }
  .label { font-size: 10px; fill:#111; text-anchor: middle; paint-order: stroke; stroke:#fff; stroke-width:3px; }
</style>
</head>
<body>
<svg id="chart" viewBox="0 0 600 600" aria-label="Pixel map of New Mexico"></svg>
<div id="county-message-box" style="display:none; margin:0; padding:18px 22px; border:2px solid #0077cc; border-radius:14px; background:linear-gradient(135deg,rgba(247,251,255,0.85) 80%,rgba(227,242,253,0.85) 100%); max-width:320px; font-size:16px; box-shadow:0 4px 18px rgba(0,0,0,0.18); z-index:1000; position:absolute; transition:box-shadow 0.2s,transform 0.2s; opacity:0.92;"></div>
<script>
const svg = d3.select("#chart");
const width = 500, height = 500;
const PIXEL = 3;
const MOE_Z = 1.645;
const VALUE_MIN = 0, VALUE_MAX = 50;

const longpal = ["#800026","#BD0026","#E31A1C","#FC4E2A","#FD8D3C","#FEB24C","#FED976","#FFE7A8","#FFF2CC","#FFF9E6"].reverse();
const color = d3.scaleLinear()
  .domain(d3.range(VALUE_MIN, VALUE_MAX+1, (VALUE_MAX - VALUE_MIN)/(longpal.length-1)))
  .range(longpal)
  .clamp(true);

function mulberry32(a){ return function(){ let t=a+=0x6D2B79F5; t=Math.imul(t^t>>>15,t|1); t^=t+Math.imul(t^t>>>7,t|61); return ((t^t>>>14)>>>0)/4294967296; } }
function randnFactory(rng){ let spare=null; return ()=>{ if(spare!==null){const v=spare; spare=null; return v;}
  let u=0,v=0,s=0; do{u=rng()*2-1; v=rng()*2-1; s=u*u+v*v;}while(s===0||s>=1);
  const m=Math.sqrt(-2*Math.log(s)/s); spare=v*m; return u*m; }; }
function sampleValue(pov, moe, randn){
  const sd = (moe ?? 0)/MOE_Z;
  const x = pov + (sd>0 ? randn()*sd : 0);
  return Math.max(VALUE_MIN, Math.min(VALUE_MAX, x));
}

const norm = s => (s||"").normalize("NFD").replace(/\p{Diacritic}/gu,"").toLowerCase().trim();

const defs      = svg.append("defs");
const gPixels   = svg.append("g").attr("class","pixels");
const gState    = svg.append("g").attr("class","state");
const gCounties = svg.append("g").attr("class","counties");
const gLabels   = svg.append("g").attr("class","labels");

const projection = d3.geoEquirectangular();
const path = d3.geoPath(projection);

function renderState(stateFips, csvFile, nameToFipsMap) {
  Promise.all([
    d3.json("https://cdn.jsdelivr.net/npm/us-atlas@3/counties-10m.json"),
    d3.csv(csvFile, d3.autoType)
  ]).then(([usTopo, csv]) => {
    // Clear previous
    gPixels.selectAll("rect").remove();
    gState.selectAll("path").remove();
    gCounties.selectAll("path").remove();
    gLabels.selectAll("text").remove();
    defs.selectAll("clipPath").remove();

    const byFips = new Map();
    for (const r of csv) {
      const fips = nameToFipsMap ? nameToFipsMap.get(norm(r.county ?? r.NAME)) : null;
      if (fips) byFips.set(fips, { pov:+r.pov, moe:+r.moe, name:r.county ?? r.NAME });
    }

    const allCounties = topojson.feature(usTopo, usTopo.objects.counties).features;
    const stateCounties  = allCounties.filter(f => String(f.id).startsWith(stateFips));
    const stateFeature   = topojson.feature(usTopo, usTopo.objects.states)
                        .features.find(f => String(f.id)===stateFips);
    const stateMesh      = topojson.mesh(usTopo, usTopo.objects.counties,
                          (a,b)=> String(a.id).startsWith(stateFips) && String(b.id).startsWith(stateFips) && a!==b);

    projection.fitSize([width, height], {type:"FeatureCollection", features: stateCounties});

    defs.append("clipPath").attr("id","stateClip")
      .append("path").attr("d", path(stateFeature));

    gState.append("path")
      .attr("d", path(stateFeature))
      .attr("fill","none").attr("stroke","#333")
      .attr("stroke-width",1.2).attr("vector-effect","non-scaling-stroke");

    gCounties.append("path")
      .attr("d", path(stateMesh))
      .attr("fill","none").attr("stroke","#595959")
      .attr("stroke-width",1.2).attr("vector-effect","non-scaling-stroke");

    gLabels.selectAll("text")
      .data(stateCounties)
      .join("text")
        .attr("class","label")
        .attr("transform", d => `translate(${path.centroid(d)})`)
        .text(d => byFips.get(String(d.id))?.name ?? String(d.id));

    const rng = mulberry32(42);
    const randn = randnFactory(rng);
    const pixels = [];

    for (let y = PIXEL/2; y < height; y += PIXEL) {
      for (let x = PIXEL/2; x < width; x += PIXEL) {
        const lonlat = projection.invert([x,y]);
        if (!lonlat) continue;

        let rec = null;
        for (const f of stateCounties) {
          if (d3.geoContains(f, lonlat)) { rec = byFips.get(String(f.id)); break; }
        }
        if (!rec) continue;

        const v = sampleValue(rec.pov, rec.moe, randn);
        pixels.push({x, y, v});
      }
    }

    gPixels.attr("clip-path","url(#stateClip)")
      .selectAll("rect")
      .data(pixels)
      .join("rect")
        .attr("x", d => d.x - PIXEL/2)
        .attr("y", d => d.y - PIXEL/2)
        .attr("width", PIXEL)
        .attr("height", PIXEL)
        .attr("fill", d => color(d.v));

    // Add invisible county paths for interaction
    let selectedCounties = [];
    const maxSelections = 3;

    function updateSelectedCountiesList() {}

    function showCountyMessageBox({ county, alreadySelected, onYes, onNo }) {
      const box = document.getElementById("county-message-box");
      let msg = "";
      if (!alreadySelected) {
        msg = `Do you want to allocate your resources to <b>${county}</b>?`;
      } else {
        msg = `You have already selected <b>${county}</b> to allocate resources.<br>Do you want to unselect it?`;
      }
      msg += `<br><br><b>Selected counties:</b> <span style='color:#0077cc'>${selectedCounties.length ? selectedCounties.join(", ") : "None"}</span>`;
      box.innerHTML = msg + `<br><br><button id='county-yes-btn' style='background:#0077cc;color:#fff;border:none;border-radius:6px;padding:7px 18px;margin-right:10px;cursor:pointer;font-size:15px;box-shadow:0 1px 4px rgba(0,0,0,0.08);transition:background 0.2s;'>Yes</button> <button id='county-no-btn' style='background:#fff;color:#0077cc;border:1.5px solid #0077cc;border-radius:6px;padding:7px 18px;cursor:pointer;font-size:15px;box-shadow:0 1px 4px rgba(0,0,0,0.08);transition:background 0.2s;'>No</button>`;
      box.style.display = "block";

      // Position the box near the centroid of the selected county
      let countyFeature = null;
      for (const f of stateCounties) {
        const name = byFips.get(String(f.id))?.name ?? String(f.id);
        if (name === county) {
          countyFeature = f;
          break;
        }
      }
      if (countyFeature) {
        const centroid = path.centroid(countyFeature);
        const svgEl = document.getElementById("chart");
        const svgRect = svgEl.getBoundingClientRect();
        box.style.position = "absolute";
        box.style.left = (svgRect.left + centroid[0]) + "px";
        box.style.top = (svgRect.top + centroid[1]) + "px";
        box.style.transform = "translate(-50%, 20px)";
        box.style.zIndex = 1000;
      } else {
        box.style.position = "absolute";
        const svgEl = document.getElementById("chart");
        const svgRect = svgEl.getBoundingClientRect();
        box.style.left = (svgRect.left + 20) + "px";
        box.style.top = (svgRect.top + 20) + "px";
        box.style.transform = "none";
        box.style.zIndex = 1000;
      }

      document.getElementById("county-yes-btn").onclick = function() {
        box.style.display = "none";
        onYes();
      };
      document.getElementById("county-no-btn").onclick = function() {
        box.style.display = "none";
        onNo();
      };
    }

    gCounties.selectAll(".county-interactive")
      .data(stateCounties)
      .join("path")
        .attr("class", "county-interactive")
        .attr("d", path)
        .attr("fill", "transparent")
        .attr("stroke", "none")
        .attr("data-county", d => byFips.get(String(d.id))?.name ?? String(d.id))
        .style("cursor", "pointer")
        .on("mouseover", function(event, d) {})
        .on("mouseout", function(event, d) {})
        .on("click", function(event, d) {
          const county = d3.select(this).attr("data-county");
          if (!selectedCounties.includes(county)) {
            if (selectedCounties.length >= maxSelections) return;
            showCountyMessageBox({
              county,
              alreadySelected: false,
              onYes: () => {
                selectedCounties.push(county);
                Revisit.postAnswers({ selectedCounties });
                updateSelectedCountiesList();
                if (selectedCounties.length === maxSelections) {
                  gCounties.selectAll(".county-interactive")
                    .filter(function() {
                      return !selectedCounties.includes(d3.select(this).attr("data-county"));
                    })
                    .style("pointer-events", "none");
                }
              },
              onNo: () => {}
            });
          } else {
            showCountyMessageBox({
              county,
              alreadySelected: true,
              onYes: () => {
                selectedCounties = selectedCounties.filter(c => c !== county);
                Revisit.postAnswers({ selectedCounties });
                updateSelectedCountiesList();
                if (selectedCounties.length < maxSelections) {
                  gCounties.selectAll(".county-interactive")
                    .style("pointer-events", "auto");
                }
              },
              onNo: () => {}
            });
          }
        });

    // Legend
    const legendW = 220, legendH = 10, margin = 20;
    const lg = svg.append("g")
      .attr("transform", `translate(${width - legendW - margin}, ${height - 40})`);

    const grad = defs.append("linearGradient")
      .attr("id","legendGrad").attr("x1","0%").attr("x2","100%")
      .attr("y1","0%").attr("y2","0%");
    for (let i=0;i<=100;i++){
      const t = i/100;
      grad.append("stop").attr("offset", `${i}%`).attr("stop-color", color(VALUE_MIN + t*(VALUE_MAX - VALUE_MIN)));
    }
    lg.append("rect").attr("width", legendW).attr("height", legendH).attr("fill", "url(#legendGrad)");
    const legendScale = d3.scaleLinear().domain([VALUE_MIN, VALUE_MAX]).range([0, legendW]);
    lg.append("g").attr("transform", `translate(0,${legendH})`)
      .call(d3.axisBottom(legendScale).ticks(5));
    lg.append("text")
      .attr("x", legendW/2).attr("y", -6).attr("text-anchor","middle")
      .text("Poverty");
  }).catch(err => {
    console.error(err);
    alert("Data load failed. Serve the folder with a local web server and keep the CSV next to this HTML file.");
  });
}

// Example county FIPS mapping for NM
const nmNameToFips = new Map([
  ["bernalillo","35001"],["catron","35003"],["chaves","35005"],["cibola","35006"],["colfax","35007"],
  ["curry","35009"],["de baca","35011"],["dona ana","35013"],["doÃ±a ana","35013"],["eddy","35015"],
  ["grant","35017"],["guadalupe","35019"],["harding","35021"],["hidalgo","35023"],["lea","35025"],
  ["lincoln","35027"],["los alamos","35028"],["luna","35029"],["mckinley","35031"],["mora","35033"],
  ["otero","35035"],["quay","35037"],["rio arriba","35039"],["roosevelt","35041"],["sandoval","35043"],
  ["san juan","35045"],["san miguel","35047"],["santa fe","35049"],["sierra","35051"],["socorro","35053"],
  ["taos","35055"],["torrance","35057"],["union","35059"],["valencia","35061"]
]);

// Listen for config data and render the requested state
Revisit.onDataReceive((data) => {
  // Expect config to provide: stateFips, csvFile, and optionally nameToFipsMap
  const stateFips = data['stateFips'] || "35";
  const csvFile = data['csvFile'] || "NMData.csv";
  // For now, only NM mapping is available. You can add more mappings for other states.
  let nameToFipsMap = nmNameToFips;
  if (data['nameToFipsMap']) {
    // If config provides a mapping, use it
    nameToFipsMap = data['nameToFipsMap'];
  }
  renderState(stateFips, csvFile, nameToFipsMap);
});

// Optionally, render NM by default if no config arrives
renderState("35", "NMData.csv", nmNameToFips);
</script>
</body>
</html>
