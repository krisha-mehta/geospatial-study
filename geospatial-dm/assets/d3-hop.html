
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Hypothetical Outcome Map (HOM)</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
<script src="https://cdn.jsdelivr.net/npm/topojson-client@3"></script>
<script src="../../revisitUtilities/revisit-communicate.js"></script>

<!--<script>
  window.Revisit = window.Revisit || {};
  if (!('postAnswers' in window.Revisit)) window.Revisit.postAnswers = (msg)=>console.log("Revisit.postAnswers:", msg);
  if (!('onDataReceive' in window.Revisit)) window.Revisit.onDataReceive = (f)=>{ window.__revisitHandler = f; };
</script>-->
<style>
  :root { color-scheme: light; }
  * { box-sizing: border-box; }
  body { margin: 0 auto;
    font-family:'Inter', system-ui, -apple-system, Segoe UI, Roboto, sans-serif; 
    background:#fff; 
    width: 650px;
    height: 550px;
  }

  .wrap { max-width:400px; margin:0 auto; padding:10px 14px 28px; }
  svg { width:100%; height:auto; display:block; background:#fff; }
  #map { max-width: 400px; }
  #legend { max-width: 140px; }

  /* county fills for HOM */
  .county { stroke:#777; stroke-width:0.8; vector-effect:non-scaling-stroke; cursor:pointer; }
  .county.on  { fill:#800000; }  /* allocate */
  .county.off { fill:#e9e9e9; }  /* not allocate */

  .state-outline { fill:none; 
    stroke:#222; 
    stroke-width:1.2; 
    vector-effect:non-scaling-stroke; 
}


  .legend { position:fixed; 
    right:14px; 
    background:#fff; 
    border:1px solid #e5e5e5;
    border-radius:10px; 
    padding:8px 10px; 
    font-size:12px; 
    color:#222; 
    box-shadow:0 2px 10px rgba(0,0,0,0.05); 
  }
  /* Progress bar styles */
  .progress-container {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: #fff;
    border: 1px solid #e5e5e5;
    border-radius: 10px;
    padding: 12px 16px;
    font-size: 12px;
    color: #222;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    min-width: 250px;
    z-index: 1000;
  }
  
  .progress-bar {
    width: 100%;
    height: 8px;
    background: #e9e9e9;
    border-radius: 4px;
    margin: 8px 0 4px;
    overflow: hidden;
  }
  
  .progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #306de7 0%, #0b5cff 100%);
    border-radius: 4px;
    transition: width 0.1s ease-out;
    width: 0%;
  }
  
 .progress-text {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-weight: 500;
  }

@media (max-width: 400px) {
    .wrap { flex-direction: column; align-items: center; max-width: 400px; }
    #legend { max-width: 400px; }
    .progress-container { 
      left: 10px; 
      right: 10px; 
      transform: none; 
      min-width: auto; 
    }
  }

   #county-message-box {
    font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
  }

  .selected-panel {
    max-width: 760px;
    margin: 30px auto 0;
    padding: 0 12px 8px;
    font-size: 14px;
    color: #111;
  }
  .selected-panel .chips {
    margin-top: 6px;
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
  }
  .chip {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 10px;
    border-radius: 999px;
    background: #f2f6ff;
    border: 1px solid #c9ddff;
    color: #0b3d91;
    line-height: 1;
    cursor: pointer;
  }
  .chip button.remove-chip {
    appearance: none;
    border: none;
    background: transparent;
    color: #0b3d91;
    font-size: 16px;
    line-height: 1;
    cursor: pointer;
    padding: 0 2px;
  }
  .chip button.remove-chip:focus-visible {
    outline: 2px solid #0b5cff;
    outline-offset: 2px;
    border-radius: 4px;
  }
  .county.highlight {
    stroke: #306de7 !important;
    stroke-width: 2.5 !important;
    pointer-events: none;
  }

  .legend_chip { width:12px; 
    height:12px; 
    border-radius:3px; 
    display:inline-block; 
    vertical-align:middle; 
    margin-right:6px; 
    border:1px solid #777; 
}
  .legend_chip.on  { 
    background:#800000; 
    border-color:#800000; 
}
  .legend_chip.off { 
    background:#e9e9e9; 
    border-color:#aaa; }

  </style>
</head>
<body>

  <div class="wrap">
    <svg id="map" viewBox="0 0 400 400" aria-label="HOM county map"></svg>
   <!--<div id="legend"><span class="legend_chip on"></span> Above Threshold Poverty Rates &nbsp; <span class="legend_chip off"></span> Below Threshold Poverty Rates</div>-->
<div class="legend">
    <div><span class="legend_chip on"></span> Above Threshold Poverty Rates</div>
    <div style="margin-top:6px"><span class="legend_chip off"></span> Below Threshold Poverty Rates</div>
  </div>
  </div>
  <div id="selected-list" class="selected-panel" aria-live="polite"></div>
  
  <div id="progress-container" class="progress-container" style="display: none;">
  <!--<div class="progress-text">
      <span>Animation Progress</span>
      <span id="frame-counter">Frame 1 / 50</span>
    </div>-->
    <div class="progress-bar">
      <div id="progress-fill" class="progress-fill"></div>
    </div>
   <!-- <div style="margin-top: 4px; font-size: 11px; color: #666; text-align: center;">
      <span id="frames-remaining">49 frames remaining in cycle</span>
      <span style="margin-left: 10px; color: #888;">● Continuous loop</span>
    </div>-->
  </div>
  
  <div id="county-message-box"
     style="display:none; margin:0; padding:18px 22px; border:2px solid #0077cc; border-radius:14px;
            background:linear-gradient(135deg,rgba(247,251,255,0.85) 80%,rgba(227,242,253,0.85) 100%);
            max-width:320px; font-size:16px; box-shadow:0 4px 18px rgba(0,0,0,0.18); z-index:1000;
            position:absolute; transition:box-shadow 0.2s,transform 0.2s; opacity:0.92;"></div>

<script>

const CONFIG = {
  THRESHOLD: 15,
  MOE_Z: 1.645,
  N_FRAMES: 50,
  FPS: 2.5,
  MAX_SELECTIONS: 3,
  REQUIRED_SELECTIONS: 3,
  RNG_SEED: 42
};

document.addEventListener('click', (event) => {
  const messageBox = document.getElementById('county-message-box');
  const map = document.getElementById('map');
  if (!messageBox.contains(event.target) && !map.contains(event.target) && messageBox.style.display === 'block') {
    messageBox.style.display = 'none';
  }
});



const svg = d3.select('#map');
const gFill = svg.append('g');
const gBorders = svg.append('g');
const gOutline = svg.append('g');

// --- Selected counties panel logic ---
let selectedCounties = [];
const maxSelections = CONFIG.MAX_SELECTIONS;

function renderSelectedList() {
  const panel = document.getElementById('selected-list');
  const requiredSelections = CONFIG.REQUIRED_SELECTIONS;
  const title = '<strong>Your selected counties:</strong>';
  if (!selectedCounties.length) {
    panel.innerHTML = `${title} <span style="color:#666;">None (need to select exactly ${requiredSelections})</span>`;
    return;
  }
  const chips = selectedCounties.map(c => (
    `<span class="chip" data-county="${c.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}">
       <span>${c.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}</span>
       <button class="remove-chip" type="button" aria-label="Remove ${c}" title="Remove ${c}" data-county="${c.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}">&times;</button>
     </span>`
  )).join('');
  
  let statusMessage = '';
  if (selectedCounties.length < requiredSelections) {
    statusMessage = `<div style="margin-top: 8px; color: #d97706; font-size: 13px;">You need to select exactly ${requiredSelections} counties. Currently selected: ${selectedCounties.length}</div>`;
  } else if (selectedCounties.length === requiredSelections) {
    statusMessage = `<div style="margin-top: 8px; color: #059669; font-size: 13px;">✓ You have selected exactly ${requiredSelections} counties. You can proceed to the next step.</div>`;
  }
  
  panel.innerHTML = `${title}<div class="chips">${chips}</div>${statusMessage}`;
}

document.addEventListener('click', (ev) => {
  const btn = ev.target;
  if (!(btn instanceof HTMLElement)) return;
  if (!btn.classList.contains('remove-chip')) return;
  const county = btn.getAttribute('data-county');
  if (!county) return;
  selectedCounties = selectedCounties.filter(c => c !== county);
  state.selected = selectedCounties;
  
  // Only post answers when exactly the required number of counties are selected
  if (selectedCounties.length === CONFIG.REQUIRED_SELECTIONS) {
    Revisit.postAnswers({ selectedCounty: selectedCounties });
  }
  
  d3.selectAll('.county').classed('highlight', false);
  if (selectedCounties.length < maxSelections) {
    gFill.selectAll('.county').style('pointer-events', 'auto');
  }
  renderSelectedList();
});

document.addEventListener('mouseover', (ev) => {
  const chip = ev.target.closest('.chip');
  if (!chip) return;
  const county = chip.getAttribute('data-county');
  if (!county) return;
  d3.selectAll('.county').classed('highlight', function() {
    return d3.select(this).attr('data-county') === county;
  });
});
document.addEventListener('mouseout', (ev) => {
  const chip = ev.target.closest('.chip');
  if (!chip) return;
  d3.selectAll('.county').classed('highlight', false);
});

const projection = d3.geoEquirectangular();
const path = d3.geoPath(projection);


const norm = s => (s||"").normalize("NFD").replace(/\p{Diacritic}/gu,"").toLowerCase().trim();
const stripTypeSuffix = (s) => s.replace(/\b(county|parish|borough|census area|municipio|municipality)\b/gi, "").replace(/\s+/g, " ").trim();

function mulberry32(a){ return function(){ let t=a+=0x6D2B79F5; t=Math.imul(t^t>>>15,t|1); t^=t+Math.imul(t^t>>>7,t|61); return ((t^t>>>14)>>>0)/4294967296; }; }
function hashStr(str){ let h=2166136261; for(let i=0;i<str.length;i++){ h^=str.charCodeAt(i); h = Math.imul(h, 16777619); } return h>>>0; }

// Normal CDF via erf approximation
function normalCdf(x, mean=0, sd=1){ 
    const z=(x-mean)/(sd||1); 
    return 0.5 * (1 + erf(z/Math.SQRT2)); 
}
function erf(x){ 
    const sign = Math.sign(x); 
    const a1=0.254829592, 
    a2=-0.284496736, 
    a3=1.421413741, 
    a4=-1.453152027, 
    a5=1.061405429, 
    p=0.3275911;
  const t = 1/(1+p*Math.abs(x)); 
  const y = 1-((((a5*t+a4)*t+a3)*t+a2)*t+a1)*t*Math.exp(-x*x);
   return sign*y; 
}


let state = {
  stateFips: null,          
  csvFile: null,            
  threshold: CONFIG.THRESHOLD,
  moeZ: CONFIG.MOE_Z,
  fps: CONFIG.FPS,
  nFrames: CONFIG.N_FRAMES,
  frame: 0,
  selected: [],
  maxSel: CONFIG.MAX_SELECTIONS,
  requiredSel: CONFIG.REQUIRED_SELECTIONS,
  rngSeed: CONFIG.RNG_SEED,
  draws: [],
  countyList: [],
  byFips: new Map(),
  animationStarted: false,
  totalFramesShown: 0
};


async function loadData(){
  const [usTopo, csv] = await Promise.all([
    d3.json('https://cdn.jsdelivr.net/npm/us-atlas@3/counties-10m.json'),
    d3.csv(state.csvFile, d3.autoType)
  ]);

  const allCounties = topojson.feature(usTopo, usTopo.objects.counties).features;
  const stateCounties = allCounties.filter(f => String(f.id).startsWith(state.stateFips));
  const stateFeature = topojson.feature(usTopo, usTopo.objects.states).features.find(f => String(f.id) === state.stateFips);
  const stateMesh = topojson.mesh(
    usTopo, usTopo.objects.counties,
    (a,b)=> String(a.id).startsWith(state.stateFips) && String(b.id).startsWith(state.stateFips) && a!==b
  );

  const nameToFips = new Map();
  for(const f of stateCounties){
    const raw = f.properties?.name ?? '';
    const base = norm(stripTypeSuffix(raw));
    nameToFips.set(base, String(f.id));
    if (/\bsaint\b/i.test(raw)){
      nameToFips.set(norm(stripTypeSuffix(raw.replace(/\bsaint\b/gi,'st'))), String(f.id));
      nameToFips.set(norm(stripTypeSuffix(raw.replace(/\bsaint\b/gi,'st.'))), String(f.id));
    }
    if (/\bst[.]?\b/i.test(raw)){
      nameToFips.set(norm(stripTypeSuffix(raw.replace(/\bst[.]?\b/gi,'saint'))), String(f.id));
    }
  }


  const byFips = new Map();
  for(const r of csv){
    const rawName = String(r.county ?? r.NAME ?? '').trim();
    const key = norm(stripTypeSuffix(rawName));
    const fips = nameToFips.get(key);
    if (!fips) { console.warn('No FIPS for', rawName); continue; }
    byFips.set(fips, { name: rawName, pov:+r.pov, moe:+r.moe });
  }


  projection.fitSize([400,400], {type:'FeatureCollection', features: stateCounties});

  svg.selectAll('*').interrupt();
  gFill.selectAll('*').remove();
  gBorders.selectAll('*').remove();
  gOutline.selectAll('*').remove();

  gOutline.append('path').attr('class','state-outline').attr('d', path(stateFeature));
  gBorders.append('path')
    .attr('d', path(stateMesh))
    .attr('fill','none').attr('stroke','#666').attr('stroke-width',0.8)
    .attr('vector-effect','non-scaling-stroke');

  // County paths
  gFill.selectAll('path.county')
    .data(stateCounties, d=>String(d.id))
    .join('path')
      .attr('class','county off')
      .attr('d', d=>path(d))
      .attr('data-fips', d=>String(d.id))
      .attr('data-county', d=>byFips.get(String(d.id))?.name ?? String(d.id))
      .style('cursor', 'pointer')
      .on('click', function(event, d) {
        const county = d3.select(this).attr('data-county');
        const alreadySelected = selectedCounties.includes(county);
        if (!alreadySelected) {
          if (selectedCounties.length >= maxSelections) return;
          showCountyMessageBox({
            county,
            onYes: () => {
              selectedCounties.push(county);
              state.selected = selectedCounties;
              
              if (selectedCounties.length === CONFIG.REQUIRED_SELECTIONS) {
                Revisit.postAnswers({ selectedCounty: selectedCounties });
              }
              
              renderSelectedList();
              if (selectedCounties.length === maxSelections) {
                gFill.selectAll('.county')
                  .filter(function() {
                    return !selectedCounties.includes(d3.select(this).attr('data-county'));
                  })
                  .style('pointer-events', 'none');
              }
            },
            onNo: () => {}
          });
        } else {
          
          const box = document.getElementById('county-message-box');
          const msg = `You have already selected this county to allocate resources.<br>To unselect, click on the <b>x</b> next to the county name below.`;
          box.innerHTML = msg + `<br><br><button id='county-ok-btn' style='background:#0077cc;color:#fff;border:none;border-radius:6px;padding:7px 18px;margin-right:10px;cursor:pointer;font-size:15px;box-shadow:0 1px 4px rgba(0,0,0,0.08);transition:background 0.2s;'>OK</button>`;
          box.style.display = 'block';
          let countyFeature = null;
          for (const f of stateCounties) {
            const name = byFips.get(String(f.id))?.name ?? String(f.id);
            if (name === county) { countyFeature = f; break; }
          }
          const svgEl = document.getElementById('map');
          const svgRect = svgEl.getBoundingClientRect();
          box.style.position = 'absolute';
          if (countyFeature) {
            const centroid = path.centroid(countyFeature);
            box.style.left = (svgRect.left + centroid[0]) + 'px';
            box.style.top  = (svgRect.top  + centroid[1]) + 'px';
            box.style.transform = 'translate(-50%, 20px)';
          } else {
            box.style.left = (svgRect.left + 20) + 'px';
            box.style.top  = (svgRect.top  + 20) + 'px';
            box.style.transform = 'none';
          }
          box.style.zIndex = 1000;
          document.getElementById('county-ok-btn').onclick = () => { box.style.display = 'none'; };
        }
      });

  renderSelectedList();



  state.countyList = stateCounties;
  state.byFips = byFips;
  if (selectedCounties.length < maxSelections) {
    gFill.selectAll('.county').style('pointer-events', 'auto');
  }

  computeXprob();
  regenerateDraws();
  renderFrame(0, true);
}

function computeXprob(){
  const t = state.threshold;
  const z = state.moeZ;
  for(const [fips, rec] of state.byFips){
    const sd = (rec.moe ?? 0) / (z || 1.645);
    rec.xprob = (!isFinite(sd) || sd <= 0)
      ? (rec.pov >= t ? 1 : 0)
      : (1 - normalCdf(t, rec.pov, sd));
  }
}

function showCountyMessageBox({ county, onYes, onNo }) {
  const box = document.getElementById("county-message-box");
  const msg = `Do you want to allocate your resources to <b>${county}</b>?`;
  box.innerHTML = msg + `<br><br><button id='county-yes-btn' style='background:#0077cc;color:#fff;border:none;border-radius:6px;padding:7px 18px;margin-right:10px;cursor:pointer;font-size:15px;box-shadow:0 1px 4px rgba(0,0,0,0.08);transition:background 0.2s;'>Yes</button> <button id='county-no-btn' style='background:#fff;color:#0077cc;border:1.5px solid #0077cc;border-radius:6px;padding:7px 18px;cursor:pointer;font-size:15px;box-shadow:0 1px 4px rgba(0,0,0,0.08);transition:background 0.2s;'>No</button>`;
  box.style.display = "block";

  let countyFeature = null;
  for (const f of state.countyList) {
    const name = state.byFips.get(String(f.id))?.name ?? String(f.id);
    if (name === county) { countyFeature = f; break; }
  }
  const svgEl = document.getElementById("map");
  const svgRect = svgEl.getBoundingClientRect();
  box.style.position = "absolute";
  if (countyFeature) {
    const centroid = path.centroid(countyFeature);
    box.style.left = (svgRect.left + centroid[0]) + "px";
    box.style.top  = (svgRect.top  + centroid[1]) + "px";
    box.style.transform = "translate(-50%, 20px)";
  } else {
    box.style.left = (svgRect.left + 20) + "px";
    box.style.top  = (svgRect.top  + 20) + "px";
    box.style.transform = "none";
  }
  box.style.zIndex = 1000;

  document.getElementById("county-yes-btn").onclick = () => { box.style.display = "none"; onYes(); };
  document.getElementById("county-no-btn").onclick  = () => { box.style.display = "none"; onNo();  };
}

function regenerateDraws(){
  state.nFrames = CONFIG.N_FRAMES;
  state.fps = CONFIG.FPS;
  const seed = state.rngSeed = Math.abs(((+new Date()) & 0xffffffff) ^ hashStr(state.stateFips + '|' + state.csvFile + '|' + state.threshold));
  const rng0 = mulberry32(seed);
  const ids = state.countyList.map(f=>String(f.id));
  const frames = [];
  for(let k=0;k<state.nFrames;k++){
    const m = new Map();
    for(const fips of ids){
      const p = state.byFips.get(fips)?.xprob ?? 0;
      m.set(fips, rng0() < p ? 1 : 0);
    }
    frames.push(m);
  }
  state.draws = frames;
  state.frame = 0;
}

function updateProgressBar() {
  const progressContainer = document.getElementById('progress-container');
  const progressFill = document.getElementById('progress-fill');
  const frameCounter = document.getElementById('frame-counter');
  const framesRemaining = document.getElementById('frames-remaining');
  
  if (!state.animationStarted) return;
  
  const currentFrame = state.frame + 1; // 1-based for display
  const totalFrames = state.nFrames;
  const remaining = totalFrames - currentFrame;
  const progressPercent = (currentFrame / totalFrames) * 100;
  
  progressFill.style.width = progressPercent + '%';
  frameCounter.textContent = `Frame ${currentFrame} / ${totalFrames}`;
  
  /*if (remaining > 0) {
    framesRemaining.textContent = `${remaining} frames remaining in cycle`;
  } else {
    framesRemaining.textContent = 'Cycle complete - restarting...';
  } */
  
  // Show progress bar when animation starts
  progressContainer.style.display = 'block';
}

function renderFrame(k){
  const nextFrame = (k % state.nFrames + state.nFrames) % state.nFrames;
  
  // If we've completed a full cycle, briefly show completion message
  if (state.frame === state.nFrames - 1 && nextFrame === 0) {
    // Reset progress bar to 0 for the new cycle
    setTimeout(() => {
      updateProgressBar();
    }, 100);
  }
  
  state.frame = nextFrame;
  const frame = state.draws[state.frame];
  gFill.selectAll('path.county')
    .classed('on', d => frame.get(String(d.id)) === 1)
    .classed('off', d => frame.get(String(d.id)) !== 1);
    
  
  updateProgressBar();
}

let lastTick = 0;
function loop(ts){
  const interval = 1000 / (state.fps || CONFIG.FPS);
  if (ts - lastTick >= interval){ 
    lastTick = ts; 
    
   
    if (!state.animationStarted) {
      state.animationStarted = true;
      updateProgressBar();
    }
    
    renderFrame(state.frame+1); 
  }
  requestAnimationFrame(loop);
}


let loopStarted = false;
function startLoopOnce(){ if (!loopStarted){ loopStarted = true; requestAnimationFrame(loop); } }


function renderState(stateFips, csvFile){
  state.stateFips = String(stateFips);
  state.csvFile = csvFile;
  selectedCounties = [];
  state.selected = selectedCounties;
  state.animationStarted = false;
  state.totalFramesShown = 0;
  
 
  const progressContainer = document.getElementById('progress-container');
  progressContainer.style.display = 'none';
  
  loadData().then(startLoopOnce).catch(e=>{
    console.error(e);
    alert('Data load failed. Serve with a local web server and place the CSV next to this HTML file.');
  });
}

Revisit.onDataReceive((data)=>{
  const fips = data['stateFips'];
  const csv  = data['csvFile'];
  if (!fips || !csv){
    console.warn('ReVISit data missing stateFips or csvFile');
    return;
  }
  renderState(fips, csv);
});
</script>
</body>
</html>
